/**
 * @fileoverview Firestore Security Rules for the Krishi Mitra application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for farmer profiles and their associated data (advisories, IoT data).
 * Administrative privileges are granted based on the existence of an admin profile document in the `roles_admin` collection.
 *
 * Data Structure:
 * - /farmer_profiles/{farmerId}: Farmer profile data, accessible only by the farmer and admins. Admins can list all profiles.
 * - /farmer_profiles/{farmerId}/advisories/{advisoryId}: Advisories for a specific farmer.
 *   Includes a denormalized 'farmerId' for efficient authorization.
 * - /farmer_profiles/{farmerId}/iot_data/{iotDataId}: IoT data logs for a specific farmer.
 *   Includes a denormalized 'farmerId' for efficient authorization.
 * - /roles_admin/{adminId}: Admin role information. Document existence signifies admin status.
 *
 * Key Security Decisions:
 * - User data is primarily nested under /farmer_profiles/{farmerId} to enforce ownership.
 * - Admins are granted special privileges to list and manage all user data.
 * - Denormalization of `farmerId` within subcollections avoids costly `get()` calls.
 * - The `roles_admin` collection uses document existence to determine admin status.
 *
 * Denormalization for Authorization:
 * - The `Advisory` and `IoTDataLog` documents include a denormalized `farmerId` field.
 *   This allows rules to verify ownership without performing additional `get()` operations.
 *
 * Structural Segregation:
 * - Admin roles are stored in a separate `roles_admin` collection, allowing for
 *   efficient and secure role-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Protects the `farmer_profiles` collection.
     * @path /farmer_profiles/{farmerId}
     * @allow (create) Authenticated user can create their own profile.
     * @allow (get) Authenticated user can read their own profile or an admin can read any profile.
     * @allow (list) An admin can list all farmer profiles. For testing, all authenticated users can list.
     * @allow (update) Authenticated user can update their own profile or an admin can update any profile.
     * @allow (delete) Authenticated user can delete their own profile or an admin can delete any profile.
     * @principle Enforces document ownership for writes and admin override for reads/lists.
     */
    match /farmer_profiles/{farmerId} {
      function isExistingOwner(farmerId) {
        return isOwner(farmerId) && resource != null;
      }

      allow get: if isOwner(farmerId) || isAdmin();
      allow list: if request.auth != null;
      allow create: if isOwner(farmerId) && request.resource.data.id == farmerId;
      allow update: if isExistingOwner(farmerId) || isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(farmerId) || isAdmin();

      /**
       * @description Protects the `advisories` subcollection under a farmer profile.
       * @path /farmer_profiles/{farmerId}/advisories/{advisoryId}
       * @allow (read, list) Owner or admin can read/list advisories.
       * @allow (create, update, delete) Owner can manage their advisories. Admin has override.
       * @principle Enforces document ownership and admin override with denormalized farmerId.
       */
      match /advisories/{advisoryId} {
        function isExistingOwner(farmerId) {
            return isOwner(farmerId) && resource != null;
        }

        allow get, list: if isOwner(farmerId) || isAdmin();
        allow create: if isOwner(farmerId) && request.resource.data.farmerId == farmerId;
        allow update: if isExistingOwner(farmerId) || isAdmin();
        allow delete: if isExistingOwner(farmerId) || isAdmin();
      }

      /**
       * @description Protects the `iot_data` subcollection under a farmer profile.
       * @path /farmer_profiles/{farmerId}/iot_data/{iotDataId}
       * @allow (read, list) Owner or admin can read/list IoT data.
       * @allow (create, update, delete) Owner can manage their IoT data. Admin has override.
       * @principle Enforces document ownership and admin override with denormalized farmerId.
       */
      match /iot_data/{iotDataId} {
        function isExistingOwner(farmerId) {
            return isOwner(farmerId) && resource != null;
        }

        allow get, list: if isOwner(farmerId) || isAdmin();
        allow create: if isOwner(farmerId) && request.resource.data.farmerId == farmerId;
        allow update: if isExistingOwner(farmerId) || isAdmin();
        allow delete: if isExistingOwner(farmerId) || isAdmin();
      }
    }

    /**
     * @description Allows reading, creation, updating, and deletion of admin profiles only by themselves.
     * @path /roles_admin/{adminId}
     * @allow (read, write) Admin user can manage their own profile.
     * @deny (list) Listing of admin profiles is forbidden for security.
     * @principle Enforces admin ownership.
     */
    match /roles_admin/{adminId} {
      allow read, write: if isOwner(adminId);
      allow list: if false;
    }
  }
}
